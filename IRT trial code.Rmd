---
title: "IRT trial code"
author: "radhika"
date: "11/29/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}


#install.packages("dplyr")
library(tidyr)
library(dplyr)
library(stringr) 
library(ggplot2)
library(readr)
library(norm)
library(knitr)


#install.packages("psych")
library(psych)
library(mirt)


#install.packages("lmtest")
library(lmtest)
```


## Objectives
*1. Simulate a response dataset, using 1PL, 2 PL and 3PL*

*2. Estimate each model and check for fit :*
a. Estimate item parameters using mirt for 1PL, 2PL and 3PL models
b. Compare model fit using LR (nested models), AIC and BIC (not nested) - (using statistics from MIRT)

####     I am not sure about how to do this part
c. Estimate item parameters using Bayesian parameter estimates
d. Compare model fit using cross-validation log likelihood (CVLL) and Deviance Information Criterion (DIC)

#### Have to do this part
*3. Prediction following Ben's work


### Simulate dataset


```{r}


 #Set the seed and generate the parameters
 
#nitem=20
#sample.size=1000
#model="2PL"

##function to generate dataset
 
fun_simulate_data= function(nitem, sample.size, model) {
  a <- as.matrix(round(rlnorm(nitem, meanlog = 0, sdlog = 1),3), ncol=1) #lognormal
  b <- as.matrix(round(rnorm(nitem, mean = 0, sd = 1),3), ncol=1) #normal
  c <- as.matrix(round(rbeta(nitem, shape1 = 5, shape2 = 17),3), ncol=1) #beta
  ability <- as.matrix(round(rnorm(sample.size, mean = 0, sd = 1),3), ncol=1) #normal

 #Simulate response data 
 	if (model == "1PL"){
 dat <- simdata(a = a, 
                d = b, 
                N = sample.size, 
                itemtype = 'dich', 
                guess = c, 
                Theta = ability)
 	}
 
 if (model == "2PL"){
 dat <- simdata(a = a, 
                d = b, 
                N = sample.size, 
                itemtype = '2PL', 
                guess = c, 
                Theta = ability)
 }
 
 if (model == "3PL"){
 dat <- simdata(a = a, 
                d = b, 
                N = sample.size, 
                itemtype = '3PL', 
                guess = c, 
                Theta = ability)
 }

  return(dat)
  
 }
 

```

# Separate 

```{r}
fun_simulate_1PL= function(nitem, sample.size, a, b, ability) {
  dat <- simdata(a = a, 
                d = b, 
                N = sample.size, 
                itemtype = 'dich', 
                Theta = ability)
  return(dat)
  }


fun_simulate_2PL= function(nitem, sample.size, a, b, ability) {
  dat <- simdata(a = a, 
                d = b, 
                N = sample.size, 
                itemtype = '2PL', 
                guess = c, 
                Theta = ability)
  return(dat)
}

fun_simulate_3PL= function(nitem, sample.size, a, b, c, ability) {
  dat <- simdata(a = a, 
                d = b, 
                N = sample.size, 
                itemtype = '3PL', 
                guess = c, 
                Theta = ability)
  return(dat)
}
```



### Extract item parameters using different models


```{r}

fun_model_fit= function(model1PL, model2PL, model3PL) {
  
#extract fit statistics
aic1PL = extract.mirt(model1PL, 'AIC')
bic1PL = extract.mirt(model1PL, 'BIC')
Gsq_1PL = extract.mirt(model1PL, 'G2')
loglik_1PL=extract.mirt(model1PL, "logLik")


parameters= cbind("model"=c("1PL"), "AIC"=round(aic1PL,3), "BIC"=round(bic1PL,3), "G-sq"=round(Gsq_1PL,3))

aic2PL = extract.mirt(model2PL, 'AIC')
bic2PL = extract.mirt(model2PL, 'BIC')
Gsq_2PL = extract.mirt(model2PL, 'G2')

parameters1= cbind("model"=c("2PL"), "AIC"=round(aic2PL,3), "BIC"=round(bic2PL,3), "G-sq"=round(Gsq_2PL,3))

aic3PL = extract.mirt(model3PL, 'AIC')
bic3PL = extract.mirt(model3PL, 'BIC')
Gsq_3PL = extract.mirt(model3PL, 'G2')
parameters2= cbind("model"=c("3PL"), "AIC"=round(aic3PL,3), "BIC"=round(bic3PL,3), "G-sq"=round(Gsq_3PL,3))

#combine fit statistics
parameters=rbind(parameters, parameters1, parameters2)

return(parameters)
}


#parameters <- as.data.frame(coef(model1PL, simplify=TRUE)$items)



```

 
 
 
### Calling functions

```{r}
# Generate datasets similar to Kang Cohen
## Study 1 -  Block 4 has 21 multiple choice items, 1000 students. the paper said 3PM was the best fit, so generating data using 3PM
data_block4 =  fun_simulate_data(21, 1000, "3PL")


# Estimate model fit 

#estimate IRT parameters
model1PL <- mirt(data=dat, 1, itemtype='Rasch', SE=TRUE, verbose=FALSE)
model2PL <- mirt(data=dat, 1, itemtype='2PL', SE=TRUE, verbose=FALSE)
model3PL <- mirt(data=dat, 1, itemtype='3PL', SE=TRUE, verbose=FALSE)

fit_statistics = fun_model_fit(model1PL, model2PL, model3PL)
fit_statistics
## 3PL gives the best fit


## Study 2 - 
# 2 test lengths, 20 and 40 items. 
# 2 sample sizes, 500 and 1000 examinees  



```


## Study 2 - Simulation Study Comparing Model Selection Indices

```{r}
#Estimate IRT parameters - 1PL
fun_est_param= function(dat_1PL) {

model1PL <- mirt(data=dat_1PL, 1, itemtype='Rasch', SE=TRUE, verbose=FALSE)
coef = as.data.frame(coef(model1PL, simplify=T)$items[,2]) %>%
  tibble::rownames_to_column(., "Item no") %>%
  mutate("b_orig"= b) %>%
  rename(b_est= "coef(model1PL, simplify = T)$items[, 2]")

return(coef)
}


fun_est_param= function(dat_2PL) {

model2PL <-  mirt(data=dat_2PL, 1, itemtype='2PL', SE=TRUE, verbose=FALSE)
b= coef(model2PL, simplify=T)$items[,2]
a=coef(model2PL, simplify=T)$items[,1]



  tibble::rownames_to_column(., "Item no") %>%
  mutate("b_orig"= b) %>%
  rename(b_est= "coef(model1PL, simplify = T)$items[, 2]")

return(coef)
}




```






```{r}
# Simulate data for Study 2

## Test length = 20 items, sample size = 500
## Item difficulty b ~ N(0,1), aâˆ¼ln(0,0.5), c~B(5,17)
## 3 distributions of ability: N(-1,1) = low ability, N(0,1) = ability at item difficulty level and N(1,1) = high ability

nitem=20
sample.size=500

a <- as.matrix(round(rlnorm(nitem, meanlog = 0, sdlog = 0.5),3), ncol=1) #lognormal
b <- as.matrix(round(rnorm(nitem, mean = 0, sd = 1),3), ncol=1) #normal
c <- as.matrix(round(rbeta(nitem, shape1 = 5, shape2 = 17),3), ncol=1) #beta
low_ability <- as.matrix(round(rnorm(sample.size, mean = -1, sd = 1),3), ncol=1) #normal
med_ability <- as.matrix(round(rnorm(sample.size, mean = 0, sd = 1),3), ncol=1) #normal
high_ability <- as.matrix(round(rnorm(sample.size, mean = 1, sd = 1),3), ncol=1) #normal

# Generate datasets, low ability
dat_1PL= fun_simulate_1PL(nitem, sample.size,  a, b, low_ability)
dat_2PL= fun_simulate_2PL(nitem, sample.size,  a, b, low_ability)
dat_3PL= fun_simulate_3PL(nitem, sample.size,  a, b, c, low_ability)

# estimate IRT parameters
## estimate parameters for 1PL
model1PL <- mirt(data=dat_1PL, 1, itemtype='Rasch', SE=TRUE, verbose=FALSE)
coef = as.data.frame(coef(model1PL, simplify=T)$items[,2]) %>%
  tibble::rownames_to_column(., "Item no") %>%
  mutate("b_orig"= b) %>%
  rename(b_est= "coef(model1PL, simplify = T)$items[, 2]")


## estimate parameters for 2PL
model2PL <- mirt(data=dat_2PL, 1, itemtype='2PL', SE=TRUE, verbose=FALSE)
b_est= coef(model2PL, simplify=T)$items[,2]
a_est=coef(model2PL, simplify=T)$items[,1]
coef_2PL = data.frame(b_est, b,  a_est, a) 
coef_2PL = tibble::rownames_to_column(coef_2PL, "Item no")


## estimate parameters for 3PL
model3PL <- mirt(data=dat_3PL, 1, itemtype='3PL', SE=TRUE, verbose=FALSE)
b_est= coef(model3PL, simplify=T)$items[,2]
a_est=coef(model3PL, simplify=T)$items[,1]
c_est=coef(model3PL, simplify=T)$items[,3]
coef_3PL = data.frame(b_est, b,  a_est, a, c_est, c) 


# Estimate RSME 
rsme = sqrt(mean((coef$b_orig - coef$b_est)^2))
rsme_b_2PL = sqrt(mean((coef_2PL$b - coef_2PL$b_est)^2))
rsme_a_2PL = sqrt(mean((coef_2PL$a - coef_2PL$a_est)^2))
rsme_b_3PL = sqrt(mean((coef_3PL$b - coef_3PL$b_est)^2))

# Compare model fit


```



# Compare model

```{r}
# Iterate for 50 loops to see which model fits best


# Generate datasets, low ability
dat_1PL= fun_simulate_1PL(nitem, sample.size,  a, b, low_ability)
dat_2PL= fun_simulate_2PL(nitem, sample.size,  a, b, low_ability)
dat_3PL= fun_simulate_3PL(nitem, sample.size,  a, b, c, low_ability)

#Estimate
model1PL <- mirt(data=dat_1PL, 1, itemtype='Rasch', SE=TRUE, verbose=FALSE)
model2PL <- mirt(data=dat_1PL, 1, itemtype='2PL', SE=TRUE, verbose=FALSE)
model3PL <- mirt(data=dat_1PL, 1, itemtype='3PL', SE=TRUE, verbose=FALSE)

compare = fun_model_fit(model1PL, model2PL, model3PL)

#Track which model fits best

	for (i in 1:iter){
	  
	}


coef(model1PL) %>%
		magrittr::extract(-length(.)) %>%
		do.call(rbind, .) %>%
		as_tibble()


```




```{r}

# Call the function for Study 2
nitem=20
sample.size=500


a <- as.matrix(round(rlnorm(nitem, meanlog = 0, sdlog = 1),3), ncol=1) #lognormal
b <- as.matrix(round(rnorm(nitem, mean = 0, sd = 1),3), ncol=1) #normal
c <- as.matrix(round(rbeta(nitem, shape1 = 5, shape2 = 17),3), ncol=1) #beta
ability <- as.matrix(round(rnorm(sample.size, mean = 0, sd = 1),3), ncol=1) #normal

  


```


