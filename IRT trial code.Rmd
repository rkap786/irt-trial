---
title: "IRT trial code"
author: "radhika"
date: "11/29/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}


library(tidyr)
library(dplyr)
library(stringr) 
library(ggplot2)
library(readr)
library(norm)
library(knitr)


#install.packages("psych")
library(psych)
library(mirt)


install.packages("lmtest")
library(lmtest)
```


## Objectives
1. Simulate a response dataset, using 1PL, 2 PL and 3PL

2. Estimate each model and check for fit:
a. Estimate item parameters using MLE for 1PL, 2PL and 3PL models
b. Compare model fit using LR (nested models), AIC and BIC (not nested)

###     I am not sure about how to do this part
3. Estimate model and check for fit using Bayesian methods 
a. Estimate item parameters using Bayesian parameter estimates
b. Compare model fit using cross-validation log likelihood (CVLL) and Deviance Information Criterion (DIC)




#Simulate dataset

#Kang and Cohen dataset sizes
## Study 1: 21 + 15 = 35 questions

```{r}


 #Set the seed and generate the parameters
 
#nitem=20
#sample.size=1000
#model="2PL"

##function to generate dataset
 
fun_simulate_data= function(nitem, sample.size, model) {
  set.seed(123)
  a <- as.matrix(round(rlnorm(nitem, meanlog = 0, sdlog = 1),3), ncol=1) #lognormal
  b <- as.matrix(round(rnorm(nitem, mean = 0, sd = 1),3), ncol=1) #normal
  c <- as.matrix(round(rbeta(nitem, shape1 = 5, shape2 = 17),3), ncol=1) #beta
 
  ability <- as.matrix(round(rnorm(sample.size, mean = 0, sd = 1),3), ncol=1) #normal

 #Simulate response data 
 	if (model == "1PL"){
 dat <- simdata(a = a, 
                d = b, 
                N = sample.size, 
                itemtype = 'dich', 
                guess = c, 
                Theta = ability)
 	}
 
 if (model == "2PL"){
 dat <- simdata(a = a, 
                d = b, 
                N = sample.size, 
                itemtype = '2PL', 
                guess = c, 
                Theta = ability)
 }
 
 if (model == "3PL"){
 dat <- simdata(a = a, 
                d = b, 
                N = sample.size, 
                itemtype = '3PL', 
                guess = c, 
                Theta = ability)
 }

  return(dat)
  
 }
 

```


## Extract item parameters using different models


```{r}

fun_model_fit= function(dat) {
  
#estimate IRT parameters
model1PL <- mirt(data=dat, 1, itemtype='Rasch', SE=TRUE, verbose=FALSE)
model2PL <- mirt(data=dat, 1, itemtype='2PL', SE=TRUE, verbose=FALSE)
model3PL <- mirt(data=dat, 1, itemtype='3PL', SE=TRUE, verbose=FALSE)

#extract fit statistics
aic1PL = extract.mirt(model1PL, 'AIC')
bic1PL = extract.mirt(model1PL, 'BIC')
Gsq_1PL = extract.mirt(model1PL, 'G2')
parameters= cbind("model"=c("1PL"), "AIC"=round(aic1PL,3), "BIC"=round(bic1PL,3), "G-sq"=round(Gsq_1PL,3))

aic2PL = extract.mirt(model2PL, 'AIC')
bic2PL = extract.mirt(model2PL, 'BIC')
Gsq_2PL = extract.mirt(model2PL, 'G2')

parameters1= cbind("model"=c("2PL"), "AIC"=round(aic2PL,3), "BIC"=round(bic2PL,3), "G-sq"=round(Gsq_2PL,3))

aic3PL = extract.mirt(model3PL, 'AIC')
bic3PL = extract.mirt(model3PL, 'BIC')
Gsq_3PL = extract.mirt(model3PL, 'G2')
parameters2= cbind("model"=c("3PL"), "AIC"=round(aic3PL,3), "BIC"=round(bic3PL,3), "G-sq"=round(Gsq_3PL,3))

#combine fit statistics
parameters=rbind(parameters, parameters1, parameters2)

return(parameters)
}


#parameters <- as.data.frame(coef(model1PL, simplify=TRUE)$items)



```


 
 
 
 
 
## Calling functions

```{r}
# Generate datasets similar to Kang Cohen
## Study 1 -  Block 4 has 21 multiple choice items, 1000 students. the paper said 3PM was the best fit, so generating data using 3PM
data_block4 =  fun_simulate_data(21, 1000, "3PL")


# Estimate model fit 
fit_statistics = fun_model_fit(data_block4)
## 3PL gives the best fit
```


